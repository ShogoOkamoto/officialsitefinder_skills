# 施設公式サイト発見スキル 仕様書 v2

## 概要

施設名称と住所を入力として、Google検索と住所照合により施設の公式サイトのトップページを自動発見するスキルです。

## 入力データ

1. **施設名称** (必須): 検索対象となる施設の名称
2. **施設の住所** (必須): 施設の所在地（都道府県〜市区町村以上を含むこと）

### 入力検証

- 両方のフィールドが必須
- 空文字列や空白のみの入力はエラー
- バリデーションエラー時は以下のJSON形式でエラーを返す：
  ```json
  {
    "success": false,
    "error": "入力エラー: 施設名称と住所は必須です"
  }
  ```

## 出力形式

### 成功時

```json
{
  "success": true,
  "facility_name": "東京タワー",
  "input_address": "東京都港区芝公園4-2-8",
  "official_site_url": "https://www.tokyotower.co.jp/",
  "matched_address": "東京都港区",
  "message": "公式サイトのトップページを発見しました"
}
```

### 失敗時

```json
{
  "success": false,
  "facility_name": "施設名",
  "input_address": "入力された住所",
  "message": "公式サイトが見つかりませんでした"
}
```

## 処理フロー

### 手順1: 入力データの検証

- 施設名称と住所が両方とも入力されているか確認
- 入力が不正な場合はエラーを返して終了

### 手順2: 住所から都道府県・市区町村を抽出

- **使用ツール**: `extract_address_tool`
- **処理内容**: 入力された施設住所から都道府県〜市区町村レベルの住所を抽出
  - 抽出レベル: 都道府県 + 市区町村（例: 「東京都港区」「北海道札幌市」）
  - 丁目・番地・建物名は抽出されない
- **実行方法**: `python -m extract_address_tool.extract`
- **エラー処理**: 住所が抽出できなかった場合（空配列が返された場合）はエラーを返して終了

### 手順3: Google検索で公式サイト候補を取得

- **使用ツール**: `google_search_tool`
- **検索クエリ構成**: `{施設名称} {都道府県市区町村}`
  - 例: 「東京タワー 東京都港区」
  - シンプルな形式でGoogle Custom Searchの関連度アルゴリズムを活用
- **取得件数**: 最大5件
- **実行方法**: `python -m google_search_tool "{クエリ}" -n 5`
- **フィルタリング**:
  - PDFファイル（`.pdf`で終わるURL）はスキップ
  - （オプション）SNS（twitter.com、facebook.com）や口コミサイト（tabelog.com、google.com/maps）の除外も検討可
- **エラー処理**:
  - 検索結果が0件の場合: `{"results": [], "count": 0}` が返される → エラーを返して終了
  - API エラー時: エラーメッセージを返して終了

### 手順4: 各URLのHTMLをダウンロード

- **使用ツール**: `playwright_download_tool`
- **処理内容**: 検索結果のURLを上から順にアクセスし、プレーンテキストを取得
- **実行方法**: `python download.py {URL} --format=text`
- **処理順序**: Google検索結果の上位から順に処理（関連度が高い順）
- **エラー処理**:
  - 404エラー、タイムアウト、認証エラーなどが発生した場合
  - エラーをログに記録し、次のURLに進む
  - 5件すべてダウンロード失敗した場合はエラーを返して終了

### 手順5: HTMLテキストから住所を抽出

- **使用ツール**: `extract_address_tool`
- **処理内容**: 取得したプレーンテキストから全ての住所を抽出
- **実行方法**: `python -m extract_address_tool.extract`
- **エラー処理**:
  - 住所が抽出できなかった場合（空配列 `[]` が返された場合）
  - 住所情報がないページ（お問い合わせページ、ニュース記事など）と判断
  - 次のURLに進む

### 手順6: 住所の照合

- **使用ツール**: `compare_address_tool`
- **処理内容**:
  - 手順2で得られた入力値の都道府県市区町村と、手順5で抽出された各住所を比較
  - マッチした場合、そのURLを候補として次の手順に進む
- **実行方法**: `python -m compare_address_tool "{住所1}" "{住所2}"`
- **比較仕様**:
  - 正規化: 全角→半角、空白除去、小文字化（NFKC normalization）
  - 比較方法: 正規化後の完全一致
  - 表記ゆれ: 全角半角・空白の違いは自動吸収
- **注意事項**: 「東京都」と「東京」は不一致と判定されるため、統一した形式を使用
- **複数マッチ時の処理**:
  - 最初にマッチしたURLのみを採用
  - Google検索結果は関連度順のため、最初にマッチしたものが最も適切
- **エラー処理**:
  - 5件すべてで住所がマッチしなかった場合
  - 「該当する公式サイトが見つかりませんでした」としてエラーを返して終了

### 手順7: トップページ判定（ハイブリッド方式）

住所がマッチしたURLについて、それが施設のトップページか否かを判定します。

#### 第1段階: URL構造による判定

以下のいずれかに該当する場合、トップページと判定：
- ドメイン直下（例: `https://example.com/`, `https://example.com/index.html`）
- パスの深さが浅い（スラッシュが2個以下）

→ トップページと判定された場合は**手順10へ**

#### 第2段階: LLMによる判定

URL構造で判定できない場合：
1. ダウンロード済みのHTMLテキストと施設名をClaudeに渡す
2. 以下のようなプロンプトで判定を依頼：
   ```
   以下のHTMLテキストは「{施設名}」の公式サイトのトップページですか？
   トップページの場合は "Yes"、そうでない場合は "No" で答えてください。

   [HTMLテキスト]
   ```
3. LLMの回答に基づいて判定

→ トップページと判定された場合は**手順10へ**
→ トップページでないと判定された場合は**手順8へ**

### 手順8: トップページURLの発見

現在のURLがトップページでない場合、トップページを探索します。

#### 探索方法

1. **ドメインルートに遷移**:
   - `https://example.com/path/to/page` → `https://example.com/`
   - playwright_download_toolでHTMLをダウンロード

2. **再度トップページ判定**:
   - 手順7の判定ロジックを実行
   - トップページと判定されれば**手順10へ**

3. **HTMLメタタグからの抽出**（オプション）:
   - それでもトップページでない場合
   - HTMLから `<link rel="home">` や `<meta property="og:url">` を抽出
   - 抽出できたURLに対して手順4〜7を再実行

#### 繰り返し回数

- 最大3回までトップページ検索を試行（初回 + 2回の再試行）
- 3回試行してもトップページが見つからなかった場合は**手順9へ**

### 手順9: 結果なしで終了

以下のいずれかの場合、結果なしで終了：
- トップページが見つからなかった
- 検索結果が0件だった
- すべてのURLで住所がマッチしなかった
- すべてのURLでダウンロードに失敗した

```json
{
  "success": false,
  "facility_name": "施設名",
  "input_address": "入力された住所",
  "message": "公式サイトが見つかりませんでした（具体的な理由）"
}
```

### 手順10: 成功レスポンスを返す

トップページが発見された場合、成功レスポンスを返して終了：

```json
{
  "success": true,
  "facility_name": "東京タワー",
  "input_address": "東京都港区芝公園4-2-8",
  "official_site_url": "https://www.tokyotower.co.jp/",
  "matched_address": "東京都港区",
  "message": "公式サイトのトップページを発見しました"
}
```

## 使用ツール一覧

### 1. extract_address_tool
- **場所**: `extract_address_tool/`
- **機能**: 日本語テキストから都道府県〜市区町村レベルの住所を抽出してJSON形式で返す
- **実行方法**: `python -m extract_address_tool.extract`
- **出力形式**: JSON配列（例: `["東京都港区", "大阪府大阪市"]`）

### 2. google_search_tool
- **場所**: `google_search_tool/`
- **機能**: Google Custom Search APIで検索、JSON形式で結果を返す
- **実行方法**: `python -m google_search_tool "query" [-n 5]`
- **出力形式**:
  ```json
  {
    "results": [
      {"title": "...", "link": "https://...", "snippet": "..."}
    ],
    "count": 1
  }
  ```
- **環境変数**: `GOOGLE_API_KEY`, `GOOGLE_CSE_ID` が必要

### 3. playwright_download_tool
- **場所**: `playwright_download_tool/`
- **機能**: PlaywrightでHTMLダウンロード、BeautifulSoupでプレーンテキスト抽出
- **実行方法**: `python download.py <URL> [--format=text|html]`
- **出力形式**: 標準出力にプレーンテキストまたはHTML

### 4. compare_address_tool
- **場所**: `compare_address_tool/`
- **機能**: 日本語住所を正規化（全角半角、空白除去）して比較
- **実行方法**: `python -m compare_address_tool <address1> <address2>`
- **出力**: 一致する場合は終了コード0、一致しない場合は終了コード1

## エラーハンドリング詳細

### タイムアウト設定

- **HTMLダウンロード**: 30秒（playwright_download_toolのデフォルト）
- **Google検索API**: 30秒（google_search_toolのデフォルト）
- **全体処理**: 5分（全ての処理を含む）

### ログ出力

以下のタイミングでログを出力（推奨）：
- 各手順の開始時・終了時
- エラー発生時（詳細なエラー情報を含む）
- 住所マッチ成功時
- トップページ発見時

ログレベル：
- **INFO**: 正常な処理の進行状況
- **WARNING**: 単一URLの処理失敗（次のURLに進む場合）
- **ERROR**: スキル全体の処理失敗

### リトライポリシー

- **ネットワークエラー**: リトライせず次のURLに進む
- **タイムアウト**: リトライせず次のURLに進む
- **API エラー**: リトライせず処理を終了
- **一時的なエラー**: 同一URLに対するリトライは行わない（検索結果の次のURLを試行）

## 実装に関する注意事項

### 住所形式の統一

- extract_address_toolは都道府県〜市区町村レベルまで抽出
- compare_address_toolは完全一致判定
- 「東京都渋谷区」と「東京」は不一致と判定される
- 入力住所と抽出住所の形式を統一すること

### Google検索の最適化

- クエリはシンプルに保つ（施設名 + 住所）
- Google Custom Searchの関連度アルゴリズムを信頼
- 不要なキーワードを追加しない

### LLM判定の最適化

- HTMLテキストが長すぎる場合は先頭N文字のみを使用（例: 5000文字）
- プロンプトは簡潔に保つ
- Yes/No の明確な回答を求める

### パフォーマンス考慮

- 並列処理は行わず、順次処理を推奨
- 最初にマッチしたURLで処理を終了するため、平均的には1-2件のURL処理で完了
- 最悪ケースでも5件のURL処理で完了

## テスト計画

### 単体テスト

各ツールの動作確認：
- extract_address_tool: 様々な形式の住所からの抽出
- google_search_tool: 検索クエリと結果の取得
- playwright_download_tool: HTMLダウンロードとテキスト抽出
- compare_address_tool: 正規化と比較ロジック

### 統合テスト

エンドツーエンドのフロー確認：
- 正常系: 公式サイトが正しく発見される
- 異常系: 検索結果0件、住所不一致など

### エッジケーステスト

- 施設名が一般的すぎる場合（例: 「市役所」）
- 住所が不完全な場合
- HTMLに住所が複数含まれる場合
- トップページでないページがヒットした場合

## バージョン履歴

- **v2.0** (2026-01-03):
  - タイポ修正（extract_address_toool → extract_address_tool）
  - 助詞の重複修正（「マッチした場合をのURL」→「マッチした場合のURL」）
  - ツール名の統一（google_search_toolを使用）
  - 出力形式をJSON形式で明確化
  - トップページ判定をハイブリッド方式で明確化
  - エラーハンドリングの詳細を追加
  - 各手順の詳細仕様を追加
  - 使用ツール一覧を追加
  - テスト計画を追加

- **v1.0**: 初版
