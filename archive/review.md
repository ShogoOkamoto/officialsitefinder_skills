# officialsitefinder_skills.md レビュー結果

## 対象ファイル
`D:\workspace\officialsitefinder_skills\officialsitefinder_skills.md`

---

## 発見された問題点

### 1. タイポ・表記ミス

#### 1-1. ツール名のタイポ（3行目）
- **問題**: `extract_address_toool` → 正しくは `extract_address_tool`（oが1つ多い）
- **影響**: 実装時にツールが見つからないエラーが発生する

#### 1-2. 助詞の重複（6行目）
- **問題**: 「マッチした場合をのURLを正解とする」
- **修正案**: 「マッチした場合のURLを正解とする」

---

### 2. ツール名の不整合 ✅ 解決

#### 2-1. Google検索ツール名の不一致（3行目）
- **問題**: `google_search_tool` と記載（仕様書3行目）
- **実態**: 以下の2つが実装済み
  - `google_search_tool/` - コマンドラインツール（JSON出力）
  - `google_search_mcp/` - MCPサーバー版
  - `.claude/skills/google_search_skill/` - Claudeスキル
- **推奨**: `google_search_tool` を使用（JSON形式で結果を受け取りやすい）

---

### 3. ツールの存在確認 ✅ 全て実装済み

#### 3-1. playwright_download_tool
- **状態**: ✅ 実装済み
- **場所**: `playwright_download_tool/`
- **機能**: PlaywrightでHTMLダウンロード、BeautifulSoupでプレーンテキスト抽出
- **実行方法**: `python download.py <URL> [--format=text|html]`

#### 3-2. extract_address_tool
- **状態**: ✅ 実装済み
- **場所**: `extract_address_tool/`
- **機能**: 日本語テキストから都道府県〜市区町村レベルの住所を抽出してJSON形式で返す
- **実行方法**: `python -m extract_address_tool.extract`

#### 3-3. compare_address_tool
- **状態**: ✅ 実装済み
- **場所**: `compare_address_tool/`
- **機能**: 日本語住所を正規化（全角半角、空白除去）して比較
- **実行方法**: `python -m compare_address_tool <address1> <address2>`

#### 3-4. google_search_tool
- **状態**: ✅ 実装済み
- **場所**: `google_search_tool/`
- **機能**: Google Custom Search APIで検索、JSON形式で結果返却
- **実行方法**: `python -m google_search_tool "query" [-n 5]`
- **備考**: `google_search_mcp` も別途存在（MCPサーバー版）

---

### 4. 仕様の曖昧さ・不足

#### 4-1. 出力形式の未定義
- **問題**: スキルの最終的な出力フォーマットが指定されていない
- **推奨形式**: JSON形式
  ```json
  {
    "success": true,
    "facility_name": "東京タワー",
    "input_address": "東京都港区芝公園4-2-8",
    "official_site_url": "https://www.tokyotower.co.jp/",
    "matched_address": "東京都港区",
    "message": "公式サイトのトップページを発見しました"
  }
  ```
- **失敗時**:
  ```json
  {
    "success": false,
    "facility_name": "施設名",
    "message": "公式サイトが見つかりませんでした"
  }
  ```

#### 4-2. 複数マッチ時の処理（手順6）
- **問題**: 複数のURLで住所がマッチした場合の処理が不明
- **推奨対応**: 最初にマッチしたもののみ返す
  - Google検索結果は関連度順にソートされているため、最初にマッチしたものが最も適切な候補
  - マッチした時点でトップページ判定に進み、成功すれば処理終了

#### 4-3. トップページ判定基準（手順7）✅ ハイブリッド方式で対応
- **採用方式**: ハイブリッド判定（URL構造 → LLM判定）
- **判定ロジック**:
  1. **第1段階: URL構造判定**
     - ドメイン直下（例: `https://example.com/`, `https://example.com/index.html`）
     - パスの深さが浅い（スラッシュ2個以下）
     - → トップページと判定
  2. **第2段階: LLM判定**
     - URL構造で判定できない場合、ダウンロードしたHTMLテキストと施設名をClaudeに渡す
     - プロンプト例: 「このHTMLは『{施設名}』のトップページですか？Yes/No で答えてください」
     - → LLMの回答に基づいて判定

#### 4-4. トップページ発見方法の不明確さ（手順8）
- **問題**: URLからトップページを見つける具体的な手法が不明
- **推奨方法**:
  1. **ドメインルートに遷移**: `https://example.com/path/to/page` → `https://example.com/`
  2. **再度トップページ判定（手順7）を実行**
  3. それでもトップページでない場合は、HTMLから `<link rel="home">` や `<meta property="og:url">` を抽出して試行

#### 4-5. ループ回数の曖昧さ（手順8）
- **問題**: 「最大2回繰り返す」が以下のどちらか不明
  - 初回 + 2回 = 計3回のチェック
  - 計2回のチェック
- **推奨**: 具体的な回数を明示（例: 「最大3回までトップページ検索を試行」）

#### 4-6. Google検索クエリの構成方法（手順3）
- **問題**: 具体的なクエリ構成方法が不明
- **推奨案**: `施設名称 都道府県市区町村` のシンプルな形式
  - 例: 「東京タワー 東京都港区」
  - Google Custom Searchが自動的に関連度の高い公式サイトを上位表示
  - 必要に応じて「公式」「公式サイト」などのキーワード追加も検討

#### 4-7. 検索結果の優先順位（手順3）
- **問題**: Google検索の上位5件をそのまま使うのか、フィルタリング条件があるのか不明
- **推奨対応**: 基本的には上位5件をそのまま使用
  - Google Custom Searchは関連度順にソート済み
  - （オプション）SNS（twitter.com、facebook.com）や口コミサイト（tabelog.com、google.com/maps）を除外するフィルタも検討可
  - PDFは `link` フィールドが `.pdf` で終わる場合にスキップ

#### 4-8. 住所抽出レベルの未定義（手順2）
- **問題**: どこまで抽出するのか不明
- **extract_address_toolの実装仕様**: 都道府県〜市区町村レベルまで抽出
  - 対応形式: 都/道/府/県 + 市/区/町/村/郡
  - 例: 「東京都渋谷区」「北海道札幌市」「京都府京都市中京区」
  - 制限: 丁目・番地・建物名は抽出しない
- **推奨**: この仕様に従い、都道府県〜市区町村レベルで比較

#### 4-9. compare_address_toolの比較ロジック（手順6）
- **compare_address_toolの実装仕様**:
  - **正規化**: 全角→半角、空白除去、小文字化（NFKC normalization）
  - **比較方法**: 正規化後の完全一致
  - **表記ゆれ**: 全角半角・空白の違いは自動吸収
- **推奨**: このツールの仕様に従い、正規化後の完全一致で判定
- **注意**: 「東京都」と「東京」は不一致と判定されるため、入力・抽出どちらも統一した形式を使用

---

### 5. エラーハンドリングの欠如

#### 5-1. Google検索結果が0件の場合
- **問題**: 処理フローが未定義
- **推奨対応**: 結果なしで終了
  - google_search_toolは0件の場合 `{"results": [], "count": 0}` を返す
  - この場合は「公式サイトが見つかりませんでした」として終了
  - （オプション）クエリを「施設名称」のみに変更して再検索も検討可

#### 5-2. HTMLダウンロード失敗時
- **問題**: 処理フローが未定義
- **推奨対応**: 次のURLに進む
  - 404エラー、タイムアウト、認証エラーなどが発生した場合
  - エラーをログに記録し、検索結果の次のURLを試行
  - 5件全て失敗した場合は「結果なし」で終了

#### 5-3. 住所抽出失敗時
- **問題**: HTMLから住所が抽出できなかった場合の処理が未定義
- **推奨対応**: 次のURLに進む
  - extract_address_toolが空配列 `[]` を返した場合
  - 住所情報がないページ（例: お問い合わせページ、ニュース記事）と判断
  - 次のURLを試行

#### 5-4. 全URLで住所がマッチしなかった場合
- **問題**: 5件すべてで住所が一致しなかった場合の処理が未定義
- **推奨対応**: 結果なしで終了
  - 「該当する公式サイトが見つかりませんでした」として終了
  - （オプション）部分一致や類似度スコアで最も近い候補を返すことも検討可

---

### 6. 詳細仕様の不足

#### 6-1. 入力検証
- **問題**: 施設名称や住所が空・不正な形式の場合の処理が未定義
- **必要な仕様**:
  - 必須チェック
  - 形式チェック
  - バリデーションエラー時の挙動

#### 6-2. タイムアウト設定
- **問題**: 各ツールの実行時間制限が未定義
- **必要な仕様**:
  - HTMLダウンロードのタイムアウト
  - 全体処理のタイムアウト
  - タイムアウト時の挙動

#### 6-3. ログ出力
- **問題**: ログ出力の要件が未定義
- **検討事項**:
  - どの処理でログを出力するか
  - ログレベル（DEBUG, INFO, ERROR）
  - ログフォーマット

#### 6-4. 中間結果の保存
- **問題**: デバッグ用に中間結果を保存するか未定義
- **検討事項**:
  - ダウンロードしたHTML
  - 抽出した住所
  - 検索クエリと結果

#### 6-5. リトライポリシー
- **問題**: ネットワークエラー時などのリトライ戦略が未定義
- **検討事項**:
  - リトライ回数
  - リトライ間隔
  - リトライ対象のエラー

---

## 推奨アクション

### ✅ 完了: 既存ツールの確認
全てのツールが実装済みであることを確認しました：
- ✅ `playwright_download_tool` - HTML/テキストダウンロード
- ✅ `extract_address_tool` - 住所抽出
- ✅ `compare_address_tool` - 住所比較
- ✅ `google_search_tool` - Google検索

### ✅ 完了: 仕様の明確化
主要な仕様の明確化が完了しました：
- ✅ 出力形式: JSON形式で確定
- ✅ トップページ判定: ハイブリッド方式（URL構造 → LLM）で確定
- ✅ エラーハンドリング: 各種エラー時の推奨対応を定義
- ✅ 住所比較: 既存ツールの仕様に基づいて明確化

### 次のステップ: 仕様書の修正
以下の修正が必要です：
1. **タイポ修正**:
   - 3行目: `extract_address_toool` → `extract_address_tool`
   - 6行目: 「マッチした場合をのURL」 → 「マッチした場合のURL」
2. **ツール名の統一**: `google_search_tool` を使用することを明記
3. **詳細仕様の追加**: このレビューで明確化した内容を仕様書に反映
4. **エラーケースの追加**: 各手順でのエラー処理を追記

### 最終フェーズ: 実装計画の策定
仕様書修正後、以下を実施：
1. **スキル本体の実装計画**:
   - Claude Code Skillとして実装
   - 各ツールの呼び出し順序とエラーハンドリング
   - LLMによるトップページ判定ロジック
2. **テスト計画**:
   - 単体テスト: 各ツールの動作確認
   - 統合テスト: エンドツーエンドのフロー確認
   - エッジケーステスト: エラーハンドリングの確認

---

## 総評

### ✅ 改善点
このレビューにより、以下が明確化されました：
- **依存ツール**: 全て実装済みであることを確認 ✅
- **エラーハンドリング**: 各種エラー時の推奨対応を定義 ✅
- **判定基準**: トップページ判定をハイブリッド方式で明確化 ✅
- **出力形式**: JSON形式で具体的に定義 ✅

### ⚠️ 残課題
実装前に以下の対応が必要です：
1. **仕様書の修正**: タイポ修正と、明確化した仕様の反映
2. **細部の詰め**: ループ回数（「最大2回」の解釈）などの曖昧な表現を明確化
3. **実装詳細の決定**: タイムアウト値、ログレベル、リトライポリシーなどの具体的な値

### 📋 実装準備状況
**準備完了度: 85%**
- 全ての依存ツールが実装済み
- 主要な仕様が明確化済み
- エラーハンドリング方針が定義済み
- 仕様書の軽微な修正のみで実装開始可能

仕様書を修正すれば、実装に進める状態です。
